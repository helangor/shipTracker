{% extends "public/templates/public_template.html" %}

{% block title %}Laivatutka{% endblock %}

{% block main %}

<!--Loading screen-->
<div id="loadingScreen">
  <h1>Ladataan laivoja</h1>
</div>

<!--Div which shows when no ships are coming towards to Mustola-->
<div id="noShips">
  <h1>Kanavassa ei Mustolaa kohti tulevia laivoja tällä hetkellä</h1>
</div>

<!--Div which shows when ships are coming towards to Mustola-->
<div class="row" id="shipData">
  <div class="col-lg-4 col-md-4 col-sm-10 shipInfo">
    <h4>Tietoa</h4>
    <p><strong>Laivan nimi: </strong><span id="shipName">{{ shipName }}</span></p>
    <p><strong>Laivan tyyppi: </strong><span id="shipType">{{ shipType }}</span></p>
    <p><strong>Maa: </strong><span id="flag">{{ flag }}</span></p>
    <p><strong>Etäisyys Mustolasta: </strong><span id="distance">{{ distance }}</span> <span>km</span> </p>
    <p><strong>ETA: </strong><span id="eta">--</span> minuuttia</p>
    <img id=shipPhoto src={{ image or 'https://www.vesseltracker.com/assets/img/gen_img_ship.png' }} alt="Ship photo">
    <p hidden id=latitude>{{ latitude }}</p>
    <p hidden id=longitude>{{ longitude }}</p>
    <p hidden id=speed>{{ speed }}</p>
    <p hidden id=distance>{{ distance }}</p>
    <p hidden id=mmsi>{{ mmsi }}</p>
    <p hidden id=destination>{{ destination }}</p>
    <p hidden id=navStat>{{ navStat }}</p>
    <p hidden id=length>{{ length }}</p>
    <p hidden id=width>{{ width }}</p>
    <p hidden id=draught>{{ draught }}</p>
  </div>

  <!--Lisätään kartta, jossa näkyy laiva-->
  <div class="col-lg-8 col-md-8 col-sm-10">
    <div id="map"></div>
    <script defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC7RqiI1IT985csNB4X2AfHSytWHacYy7c&callback=initMap"></script>
  </div>
</div>

  <script>
    var marker;
    var map;
    var image;
    var lat;
    var lng;
    var speed = $('#speed').text()
    var distance = $('#distance').text()


    //Initializing map
    function initMap() {
      lat = parseFloat($('#latitude').html())
      lng = parseFloat($('#longitude').html())
      if (isNaN(lat)) {
        lat = 0;
        lng = 0;
      }
      var ship = { lat: lat, lng: lng }; // The location of ship
      map = new google.maps.Map(document.getElementById('map'), { zoom: 14, center: ship });

      image = $('#shipPhoto').attr('src');

      //info window that shows extra data in when the google maps ship icon is clicked on
      infoWindow = new google.maps.InfoWindow({
        content: "<div style='float:right; padding: 10px;'>" +
          "<p><strong>MMSI: </strong><span>{{ mmsi }}</span></p>" +
          "<p><strong>Määränpää: </strong><span>{{ destination }}</span></p>" +
          "<p><strong>Nopeus: </strong><span>{{ speed }}</span> solmua</p>" +
          "<p><strong>Pituus/leveys/syväys: </strong><span>{{ length }}</span><span> / </span><span>{{ width }}</span><span> / </span><span>{{ draught }}</span> m</p>" +
          "<p><strong>Status: </strong><span>{{ navStat }}</span></p>"
      });
      //custom icon
      var icon = {
        url: "https://image.flaticon.com/icons/svg/3455/3455497.svg",
        scaledSize: new google.maps.Size(50, 50), // scaled size
      };

      // The marker, positioned at ship
      marker = new google.maps.Marker({
        position: new google.maps.LatLng(lat, lng),
        map: map,
        icon: icon,
        anchor: new google.maps.Point(25, 25)
      });
      marker.addListener("click", () => {
        infoWindow.open(map, marker);
      });
    }

    //Updates ship marker position in the map
    function moveMarker() {
      lat = parseFloat($('#latitude').html());
      lng = parseFloat($('#longitude').html());
      var newLatLng = new google.maps.LatLng(lat, lng);
      marker.setPosition(newLatLng);
      map.setCenter(newLatLng);
    }

    //Estimates how long time it takes for ship to arrive in Mustola
    function calculateEta() {
      speed = $('#speed').text()
      distance = $('#distance').text()
      const eta = Math.round((distance / (speed * 1.852)) * 60)
      $('#eta').text(eta);
    }

    function updateInfoWindowContent() {
      infoWindow.setContent("<div style='float:right; padding: 10px;'>" +
          "<p><strong>MMSI: </strong><span>" + $('#mmsi').text() + "</span></p>" +
          "<p><strong>Määränpää: </strong><span>"+ $('#destination').text() + "</span></p>" +
          "<p><strong>Nopeus: </strong><span>"+ $('#speed').text() + "</span> solmua</p>" +
          "<p><strong>Pituus/leveys/syväys: </strong><span>"+ $('#length').text() + "</span><span> / </span><span>"+ $('#width').text() + "</span><span> / </span><span>"+ $('#draught').text() + "</span> m</p>" +
          "<p><strong>Status: </strong><span>"+ $('#navStat').text() + "</span></p>");
    }

    //Hides ship data and shows noshipsdata JOS shipname = NULL niin tämä, jos ei niin showShip.
    function hideShipData() {
      var shipName = $('#shipName').text()
      if (shipName) {
        shipData.style.display = "flex";
        noShips.style.display = "none";
        loadingScreen.style.display = "none";
        calculateEta();
        moveMarker();
        updateInfoWindowContent();
      }
      else {
        shipData.style.display = "none";
        noShips.style.display = "flex";
        loadingScreen.style.display = "none";
      }
    }

    //Updates ship data in x seconds interval
    setInterval(function () {
      $.ajax({
        type: 'POST',
        url: '/',
      })
        .done(function (data) {
          $('#shipName').text(data.shipName);
          $('#mmsi').text(data.mmsi);
          $('#course').text(data.course);
          $('#length').text(data.length);
          $('#width').text(data.width);
          $('#draught').text(data.draught);
          $('#flag').text(data.flag);
          $('#shipType').text(data.shipType);
          $('#distance').text(data.distance);
          $('#speed').text(data.speed);
          $('#destination').text(data.destination);
          $('#navStat').text(data.navStat);
          $('#latitude').text(data.latitude);
          $('#longitude').text(data.longitude);
          $('#shipPhoto').attr('src', data.image);
          hideShipData();
        });
    }, 5000);

  </script>
{% endblock %}